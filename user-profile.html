<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile - AI Hiring Platform</title>
  <link rel="stylesheet" href="global.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-content">
      <a href="landing.html" class="navbar-brand">AI Hiring</a>
      <ul class="navbar-nav">
        <li><a href="jobs-listing.html" class="navbar-link">Browse Jobs</a></li>
        <li><a href="user-dashboard.html" class="navbar-link">My Applications</a></li>
        <li><a href="user-profile.html" class="navbar-link">Profile</a></li>
        <li><a href="#" onclick="logout()" class="navbar-link">Logout</a></li>
      </ul>
    </div>
  </nav>

  <!-- Profile Section -->
  <section class="dashboard">
    <div class="container-narrow">
      <!-- Page Header -->
      <div class="dashboard-header">
        <h1 class="dashboard-title">My Profile</h1>
      </div>

      <!-- Alert Messages -->
      <div id="successMessage" class="alert alert-success hidden"></div>
      <div id="errorMessage" class="alert alert-error hidden"></div>

      <!-- Profile Form Card -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Personal Information</h2>
        </div>
        <div class="card-body">
          <form id="profileForm">
            <div class="form-group">
              <label for="fullName" class="form-label">Full Name</label>
              <input 
                type="text" 
                id="fullName" 
                name="fullName" 
                class="form-input" 
                placeholder="John Doe"
                value="John Doe"
                required
              >
            </div>

            <div class="form-group">
              <label for="email" class="form-label">Email Address</label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                class="form-input" 
                placeholder="john.doe@example.com"
                value="john.doe@example.com"
                required
              >
              <span class="form-help">Used for login and notifications</span>
            </div>

            <div class="form-group">
              <label for="phone" class="form-label">Phone Number</label>
              <input 
                type="tel" 
                id="phone" 
                name="phone" 
                class="form-input" 
                placeholder="+1 234 567 8900"
                value="+1 234 567 8900"
                required
              >
            </div>

            <div class="form-group">
              <label for="whatsapp" class="form-label">WhatsApp Number (Optional)</label>
              <input 
                type="tel" 
                id="whatsapp" 
                name="whatsapp" 
                class="form-input" 
                placeholder="+1 234 567 8900"
              >
            </div>

            <div class="form-group">
              <label for="location" class="form-label">Location (Optional)</label>
              <input 
                type="text" 
                id="location" 
                name="location" 
                class="form-input" 
                placeholder="San Francisco, CA"
              >
            </div>

            <div class="form-group">
              <label for="bio" class="form-label">Professional Bio (Optional)</label>
              <textarea 
                id="bio" 
                name="bio" 
                class="form-textarea" 
                placeholder="Tell us about yourself..."
                rows="4"
              ></textarea>
            </div>

            <button type="submit" class="btn btn-primary btn-large">
              Save Changes
            </button>
          </form>
        </div>
      </div>

      <!-- Change Password Card -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Change Password</h2>
        </div>
        <div class="card-body">
          <form id="passwordForm">
            <div class="form-group">
              <label for="currentPassword" class="form-label">Current Password</label>
              <input 
                type="password" 
                id="currentPassword" 
                name="currentPassword" 
                class="form-input"
                required
              >
            </div>

            <div class="form-group">
              <label for="newPassword" class="form-label">New Password</label>
              <input 
                type="password" 
                id="newPassword" 
                name="newPassword" 
                class="form-input"
                minlength="8"
                required
              >
              <span class="form-help">At least 8 characters</span>
            </div>

            <div class="form-group">
              <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
              <input 
                type="password" 
                id="confirmNewPassword" 
                name="confirmNewPassword" 
                class="form-input"
                minlength="8"
                required
              >
              <span id="passwordError" class="form-error hidden">Passwords do not match</span>
            </div>

            <button type="submit" class="btn btn-primary">
              Update Password
            </button>
          </form>
        </div>
      </div>

      <!-- Account Info Card -->
      <div class="card" style="background: #f9f9f9;">
        <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Important Note</h3>
        <p class="text-muted" style="margin: 0;">
          Resume is uploaded separately for each job application. We don't store a central resume to ensure 
          you can tailor your application for each position.
        </p>
      </div>

      <!-- Delete Account Section -->
      <div class="card" style="border-color: #fee2e2;">
        <div class="card-header" style="border-color: #fee2e2;">
          <h3 class="card-title" style="color: #dc2626;">Danger Zone</h3>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">
            Once you delete your account, there is no going back. All your applications and data will be permanently removed.
          </p>
          <button class="btn btn-danger" onclick="confirmDeleteAccount()">
            Delete Account
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <p class="footer-text">&copy; 2024 AI Hiring Platform. All rights reserved.</p>
      <ul class="footer-links">
        <li><a href="privacy.html" class="footer-link">Privacy Policy</a></li>
      </ul>
    </div>
  </footer>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Delete Account</h3>
        <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete your account? This action cannot be undone.</p>
        <p class="text-bold">All your applications and data will be permanently removed.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn btn-danger" onclick="deleteAccount()">Delete Permanently</button>
      </div>
    </div>
  </div>

  <script>
    // Check authentication
    const token = localStorage.getItem('userToken');
    if (!token) {
      window.location.href = 'user-login.html';
    }

    // Logout function
    function logout() {
      localStorage.removeItem('userToken');
      localStorage.removeItem('userType');
      window.location.href = 'landing.html';
    }

    // Load user profile
    async function loadProfile() {
      try {
        const response = await fetch('/api/user/profile', {
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        });
        
        const data = await response.json();
        
        if (response.ok && data.user) {
          // Populate form fields
          document.getElementById('fullName').value = data.user.fullName || '';
          document.getElementById('email').value = data.user.email || '';
          document.getElementById('phone').value = data.user.phone || '';
          document.getElementById('whatsapp').value = data.user.whatsapp || '';
          document.getElementById('location').value = data.user.location || '';
          document.getElementById('bio').value = data.user.bio || '';
        }
      } catch (error) {
        console.error('Error loading profile:', error);
      }
    }

    // Handle profile form submission
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const successDiv = document.getElementById('successMessage');
      const errorDiv = document.getElementById('errorMessage');
      
      successDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');
      
      const formData = {
        fullName: document.getElementById('fullName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        whatsapp: document.getElementById('whatsapp').value,
        location: document.getElementById('location').value,
        bio: document.getElementById('bio').value,
      };
      
      try {
        const response = await fetch('/api/user/profile', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
          },
          body: JSON.stringify(formData),
        });
        
        const data = await response.json();
        
        if (response.ok) {
          successDiv.textContent = 'Profile updated successfully!';
          successDiv.classList.remove('hidden');
          window.scrollTo(0, 0);
        } else {
          errorDiv.textContent = data.message || 'Failed to update profile.';
          errorDiv.classList.remove('hidden');
          window.scrollTo(0, 0);
        }
      } catch (error) {
        console.error('Profile update error:', error);
        errorDiv.textContent = 'An error occurred. Please try again.';
        errorDiv.classList.remove('hidden');
        window.scrollTo(0, 0);
      }
    });

    // Handle password change
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmNewPassword').value;
      const passwordError = document.getElementById('passwordError');
      const successDiv = document.getElementById('successMessage');
      const errorDiv = document.getElementById('errorMessage');
      
      passwordError.classList.add('hidden');
      successDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');
      
      if (newPassword !== confirmPassword) {
        passwordError.classList.remove('hidden');
        return;
      }
      
      const formData = {
        currentPassword: document.getElementById('currentPassword').value,
        newPassword: newPassword,
      };
      
      try {
        const response = await fetch('/api/user/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
          },
          body: JSON.stringify(formData),
        });
        
        const data = await response.json();
        
        if (response.ok) {
          successDiv.textContent = 'Password updated successfully!';
          successDiv.classList.remove('hidden');
          document.getElementById('passwordForm').reset();
          window.scrollTo(0, 0);
        } else {
          errorDiv.textContent = data.message || 'Failed to update password.';
          errorDiv.classList.remove('hidden');
          window.scrollTo(0, 0);
        }
      } catch (error) {
        console.error('Password change error:', error);
        errorDiv.textContent = 'An error occurred. Please try again.';
        errorDiv.classList.remove('hidden');
        window.scrollTo(0, 0);
      }
    });

    // Password match validation
    document.getElementById('confirmNewPassword').addEventListener('input', () => {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmNewPassword').value;
      const passwordError = document.getElementById('passwordError');
      
      if (confirmPassword && newPassword !== confirmPassword) {
        passwordError.classList.remove('hidden');
      } else {
        passwordError.classList.add('hidden');
      }
    });

    // Delete account modal
    function confirmDeleteAccount() {
      document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
    }

    async function deleteAccount() {
      try {
        const response = await fetch('/api/user/account', {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        });
        
        if (response.ok) {
          alert('Account deleted successfully');
          logout();
        } else {
          alert('Failed to delete account');
        }
      } catch (error) {
        console.error('Delete account error:', error);
        alert('An error occurred');
      }
    }

    // Load profile on page load
    // loadProfile(); // Uncomment when backend is ready
  </script>
</body>
</html>
